language: java

jdk:
  - oraclejdk8
  - oraclejdk7

service:
  - mysql

install:
  - echo Skipping Install

before_script:
  - sudo apt-get install -y libmysql-java
  - mysql -u root -e "USE mysql; UPDATE user SET password=PASSWORD('password') WHERE user='root'; FLUSH PRIVILEGES; "
  - mysqladmin --user=root --password=password create icat
  - echo Downloading GlassFish
  - wget http://download.java.net/glassfish/4.0/release/glassfish-4.0.zip
  - echo Unzipping GlassFish
  - unzip -q glassfish-4.0.zip
  - echo Add GlassFish to PATH
  - export PATH=$PATH:$TRAVIS_BUILD_DIR/glassfish4/bin
  - echo Download the GlassFish Setup script
  - wget https://icatproject.org/misc/scripts/setup-glassfish.py
  - echo Run the GlassFish Setup script
  - python setup-glassfish.py localhost 75% 'password'
  - echo Copy the MySQL connector and restart Glassfish
  - cp /usr/share/java/mysql-connector-java.jar $TRAVIS_BUILD_DIR/glassfish4/glassfish/domains/localhost/lib/ext/
  - asadmin stop-domain localhost
  - asadmin start-domain localhost
  - echo Downloading Authn.db
  - wget https://repo.icatproject.org/repo/org/icatproject/authn.db/2.0.0/authn.db-2.0.0-distro.zip
  - echo Unzipping Authn.db
  - unzip -q authn.db-2.0.0-distro.zip
  - cd authn.db
  - echo Creating config files
  - |
    echo "#Glassfish
    secure = false
    container = Glassfish
    home = $TRAVIS_BUILD_DIR/glassfish4
    port = 4848
    # MySQL
    db.target      = mysql
    db.driver      = com.mysql.jdbc.jdbc2.optional.MysqlDataSource
    db.url         = jdbc:mysql://127.0.0.1:3306/icat
    db.username    = root
    db.password    = password" > setup.properties
  - printf "ip =127.0.0.1/32\nmechanism = db" > run.properties
  - ./setup install
  - cd $TRAVIS_BUILD_DIR
  - mysql --user=root --password=password --execute="INSERT INTO PASSWD (userName, encodedPassword) VALUES ('notroot', 'password'), ('piOne', 'piOne'), ('piTwo', 'piTwo'), ('guest', 'guess'), ('root', 'password');" icat
  - echo Downloading icat.lucene
  - wget https://repo.icatproject.org/repo/org/icatproject/icat.lucene/1.0.0/icat.lucene-1.0.0-distro.zip
  - echo Unzipping icat.lucene
  - unzip -q icat.lucene-1.0.0-distro.zip
  - echo Creating data directory for icat.lucene
  - mkdir lucene
  - echo Configuring icat.lucene
  - cd icat.lucene
  - |
    echo "#Glassfish
    secure = false
    container = Glassfish
    home = $TRAVIS_BUILD_DIR/glassfish4
    port = 4848" > setup.properties
  - |
    echo "directory = $TRAVIS_BUILD_DIR/lucene
    commitSeconds = 5
    ip = 127.0.0.1/32" > run.properties
  - ./setup install
  - cd $TRAVIS_BUILD_DIR
    
script:
  - mvn install -Dmaven.javadoc.skip=true -B -V -DserverUrl=http://127.0.0.1:8080 -DluceneUrl=http://127.0.0.1:8080 -Djavax.net.ssl.trustStore=$TRAVIS_BUILD_DIR/glassfish4/glassfish/domains/domain1/config/cacerts.jks -DcontainerHome=$TRAVIS_BUILD_DIR/glassfish4

cache:
  directories:
    - $HOME/.m2/repository

after_failure:
  - cat $TRAVIS_BUILD_DIR/glassfish4/glassfish/domains/localhost/logs/*.log
